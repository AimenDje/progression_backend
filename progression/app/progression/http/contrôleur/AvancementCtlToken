<?php


use progression\domaine\interacteur\ObtenirAvancementInt;
use progression\http\transformer\AvancementTransformer;
use progression\util\Encodage;

class AvancementCtlToken extends Contrôleur
{


    public function get(Request $request, $token)
    {
        $avancement = $this->obtenirAvancementParToken($token);

        Log::debug("AvancementCtl.get. Params : ", [$request->all(), $avancement->userName, $avancement->urlQuest]);

        $réponse = $this->valider_et_préparer_réponse($avancement, $avancement->userName, $avancement->urlQuest);

        Log::debug("AvancementCtl.get. Retour : ", [$réponse]);
        return $réponse;
    }

    private function obtenirAvancementParToken($token)
    {
        $avancementInt = new ObtenirAvancementInt();
        $avancement = $avancementInt->getAvancementParToken($token);

        Log::debug("AvancementCtl.obtenir_avancement. Params : ", [$avancement->userName,  $avancement->urlQuest]);

        $chemin = Encodage::base64_decode_url( $avancement->urlQuest);


        Log::debug("AvancementCtl.obtenir_avancement. Retour : ", [$avancement]);
        return $avancement;
    }

    private function valider_et_préparer_réponse($avancement, $username, $question_uri)
    {
        Log::debug("AvancementCtl.valider_et_préparer_réponse. Params : ", [$avancement, $username, $question_uri]);

        if ($avancement) {
            $avancement->id = "{$username}/$question_uri";
            $réponse_array = $this->avancement_to_array($avancement);
        } else {
            $réponse_array = null;
        }

        $réponse = $this->préparer_réponse($réponse_array);

        Log::debug("AvancementCtl.valider_et_préparer_réponse. Retour : ", [$réponse]);
        return $réponse;
    }

    private function avancement_to_array($avancement)
    {
        Log::debug("AvancementCtl.avancement_to_array. Params : ", [$avancement]);

        $réponse = $this->item($avancement, new AvancementTransformer());

        Log::debug("AvancementCtl.avancement_to_array. Retour : ", [$réponse]);

        return $réponse;
    }
}